<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="net.homeplus.offline.sr.view.dao.ViewDao">

<select id="selectSRTypeList" parameterType="String" resultType="TypeVO">

SELECT SR_TYPE_ID
     , SR_TYPE_NM
     , TGR_TP_CD
     , APPR_REQ_YN
     , USE_YN
FROM   TB_SR_TYPE
WHERE  USE_YN = 'Y'
<if test="tgrTpCd != null and tgrTpCd != ''">
AND    TGR_TP_CD = #{tgrTpCd}
</if>
</select>

<select id="selectSystemList" parameterType="String" resultType="SystemVO">

SELECT SYS_ID
     , SYS_NM
     , SYS_TP_CD
     , SYS_DESC
     , SYS_DEPT_ID
     , SYS_CHRG_EMP_ID
     , SYS_SUB_EMP_ID
     , DISP_ORD
FROM   TB_SYSTEM
WHERE  SYS_TP_CD = #{sysTpCd}
AND    USE_YN = 'Y'
ORDER  BY DISP_ORD

</select>

<select id="selectSystemListByCate" parameterType="String" resultType="SystemVO">

SELECT SYS_ID
     , SYS_NM
     , SYS_TP_CD
     , SYS_DESC
     , SYS_DEPT_ID
     , SYS_CHRG_EMP_ID
     , DISP_ORD
     , ATTR1
FROM   TB_SYSTEM
WHERE  SYS_CATE_ID = #{sysCateId}
AND    USE_YN = 'Y'
ORDER  BY SYS_NM DESC

</select>

<select id="selectModuleList" parameterType="String" resultType="ModuleVO">

SELECT TM.MOD_ID
     , TM.SYS_ID
     , TM.MOD_NM
     , TM.MOD_DESC
     , TM.MOD_CHRG_EMP_ID
     , TU.USER_NM AS modChrgEmpNm
     , TM.MOD_CHRG_DEPT_ID
FROM   TB_MODULE TM
       LEFT OUTER JOIN TB_USER TU
       ON TM.MOD_CHRG_EMP_ID = TU.USER_ID
WHERE  SYS_ID = #{sysId}

</select>


	<select id="selectCommonCodeList" parameterType="String" resultType="CodeVO">

SELECT CD_GRP_ID
     , CD_ID
     , CD_NM
     , ATTR1
     , ATTR2
     , ATTR3
FROM   TB_COMM_DETAIL
WHERE  CD_GRP_ID = #{cdGrpId}
AND    USE_YN = 'Y'
ORDER  BY DISP_ORD

	</select>
	

<select id="selectEmpList" parameterType="UserVO" resultType="UserVO">	

SELECT TU.USER_ID
     , TU.USER_NM
     , TU.DEPT_ID
     , TD.DEPT_NM
     , TU.LEVEL_CD
     , TU.GUBUN
     , TU.EMAIL
     , TU.JOB_TITLE
FROM   TB_USER TU
       LEFT  OUTER JOIN TB_DEPT TD
       ON TU.DEPT_ID = TD.DEPT_ID
WHERE  (TU.USER_ID LIKE '%'||#{searchWord}||'%' OR TU.USER_NM LIKE '%'||#{searchWord}||'%')
<if test="userId != null and userId != ''">
AND    TU.USER_ID != #{userId}
</if>
ORDER  BY TD.DEPT_NM, TU.USER_NM

</select>

<select id="selectSRDetail" parameterType="SRViewVO" resultType="SRViewVO">	

SELECT TS.SR_ID
     , TS.SR_TYPE_ID
     , TST.SR_TYPE_NM as srTypeNm
     , TS.SYS_ID
     , TSYS.SYS_NM as sysNm
     , TS.REQ_EMP_ID
     , TU.USER_NM  as reqEmpNm 
     , TS.REQ_EMP_DEPT_ID
     , TD.DEPT_NM AS reqEmpDeptNm
     , TS.REQ_EMP_EMAIL
     , TS.REQ_EMP_TEL
     , TS.TITLE
     , TS."DESC"
     , TS.CONF_DATA_YN
     , TS.TGT_DTTM
     , TS.STATUS
     , TCD2.CD_NM as statusNm
     , TS.CHRG_EMP_ID
     , COALESCE(TU2.USER_NM, TS.CHRG_EMP_ID)  as chrgEmpNm 
     , TS.CHRG_EMP_DEPT_ID
     , TS.FINAL_APRV_DTTM
     , TS.CLOSE_DTTM
     , TS.ETC1
     , TS.ETC2
     , TS.DATA_TYPE
     , TS.CRT_ID
     , TS.CRT_DTTM
     , TS.LAST_MOD_ID
     , TS.LAST_MOD_DTTM
     , TS.SR_NO 
     , TS.SYS_CATE_ID
     , TCD.CD_NM as sysCateNm
     , TS.MOD_ID
     , TM.MOD_NM as modNm
     , TS.IF_TYPE
     , TS.RESULT_DESC
     , TS.EST_END_DTTM
FROM   TB_SR TS
       LEFT OUTER JOIN TB_USER TU
       ON TS.REQ_EMP_ID = TU.USER_ID
       LEFT OUTER JOIN TB_USER TU2
       ON TS.CHRG_EMP_ID = TU2.USER_ID
       LEFT OUTER JOIN TB_DEPT TD
       ON TS.REQ_EMP_DEPT_ID = TD.DEPT_ID
       LEFT OUTER JOIN TB_SYSTEM TSYS
       ON TS.SYS_ID = TSYS.SYS_ID
       LEFT OUTER JOIN TB_MODULE TM
       ON TS.MOD_ID = TM.MOD_ID AND TS.SYS_ID = TM.SYS_ID
       LEFT OUTER JOIN TB_COMM_DETAIL TCD
       ON TS.SYS_CATE_ID = TCD.CD_ID
       LEFT OUTER JOIN TB_SR_TYPE TST
       ON TS.SR_TYPE_ID = TST.SR_TYPE_ID
       LEFT OUTER JOIN TB_COMM_DETAIL TCD2
       ON TS.STATUS = TCD2.CD_ID AND TCD2.CD_GRP_ID = 'SRS'
WHERE  SR_NO = #{srNo}
ORDER  BY TS.SR_ID
FETCH  FIRST 1 ROWS ONLY
</select>


<select id="selectSRList" parameterType="SRViewVO" resultType="SRViewVO">	
SELECT *
FROM   (
SELECT TS.SR_ID
     , TS.SR_NO 
     , TS.SR_TYPE_ID
     , TST.SR_TYPE_NM
     , TS.SYS_ID
     , TSYS.SYS_NM
     , TS.REQ_EMP_ID
     , TU.USER_NM  as reqEmpNm 
     , TS.REQ_EMP_DEPT_ID
     , TD.DEPT_NM AS reqEmpDeptNm
     , TS.TITLE
     , TS.TGT_DTTM
     , TS.STATUS
     , TCD.CD_NM as statusNm
     , TS.CHRG_EMP_ID
     , COALESCE(TU2.USER_NM, TS.CHRG_EMP_ID)  as chrgEmpNm 
     , TS.CRT_ID
     , TS.CRT_DTTM
     , TS.IF_TYPE
     , SMALLINT(RANK() OVER(ORDER BY TS.SR_ID DESC )) AS ROW_NO
     , CAST(#{currentPage} AS INT) AS currentPage
     , CEIL(CAST(COUNT(*) OVER() AS FLOAT) / CAST (15 AS FLOAT)) AS totalPage 
FROM   TB_SR TS
       LEFT OUTER JOIN TB_USER TU
       ON TS.REQ_EMP_ID = TU.USER_ID
       LEFT OUTER JOIN TB_DEPT TD
       ON TS.REQ_EMP_DEPT_ID = TD.DEPT_ID
       LEFT OUTER JOIN TB_SR_TYPE TST
       ON TS.SR_TYPE_ID = TST.SR_TYPE_ID
       LEFT OUTER JOIN TB_SYSTEM TSYS
       ON TS.SYS_ID = TSYS.SYS_ID
       LEFT OUTER JOIN TB_USER TU2
       ON TS.CHRG_EMP_ID = TU2.USER_ID
       LEFT OUTER JOIN TB_COMM_DETAIL TCD
       ON TS.STATUS = TCD.CD_ID AND TCD.CD_GRP_ID = 'SRS'
WHERE  TS.CRT_DTTM BETWEEN TIMESTAMP(#{strDt}||' 00:00:00') AND TIMESTAMP(#{endDt}||' 23:59:59')
AND    TS.STATUS != 'CANCEL'
<if test="srNo != null and srNo != ''">
AND    TS.SR_NO LIKE '%'||#{srNo}||'%'
</if>
<if test="reqEmpId != null and reqEmpId != ''">
AND    TS.REQ_EMP_ID = #{reqEmpId}
</if>
<if test="title != null and title != ''">
AND    TS.TITLE LIKE '%'||#{title}||'%'
</if>
<if test="status != null and status != ''">
AND    TS.STATUS = #{status} 
</if>
<if test="ifType != null and ifType != ''">
AND    TS.IF_TYPE = #{ifType} 
</if>
<if test="srTypeId != null and srTypeId != ''">
AND    TS.SR_TYPE_ID = #{srTypeId} 
</if>
<if test="superUser != 'YES'">
AND    (EXISTS(SELECT TAH.SR_ID
              FROM   TB_APPROVAL_HIST TAH
              WHERE  TAH.SR_ID = TS.SR_ID
              AND    TAH.APRV_STATUS NOT IN ('WAITING', 'CANCEL', 'CLOSE')
              AND    TAH.APRV_EMP_ID = #{userId} 
              )
        OR REQ_EMP_ID = #{userId} )
</if>
ORDER  BY TS.SR_ID DESC
)

WHERE ROW_NO > (15 * CAST(#{currentPage} AS INT) - 15) 
AND   ROW_NO <![CDATA[<=]]>  (15 * CAST(#{currentPage} AS INT) )

</select>





</mapper>