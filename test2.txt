<mapper namespace="Intergrate">

<select id="selectRTCSRList"  resultType="PushVO">	

SELECT TS.SR_ID AS srId
     , TS.SR_TYPE_ID AS reqType
     , TSYS.SYS_NM AS sysNm
     , TU.USER_NM  AS reqEmpNm 
     , TD.DEPT_NM AS reqEmpDeptNm
     , TS.REQ_EMP_EMAIL AS reqEmail
     , TS.REQ_EMP_TEL AS reqTel
     , TS.TITLE AS reqTitle
     , TS."DESC" AS reqDesc
     , TS.CONF_DATA_YN AS piYn
     , VARCHAR_FORMAT(TS.TGT_DTTM, 'YYYYMMDD') AS expDate 
     , TU2.USER_NM AS workNm 
     , TS.ETC1 AS dataWktype
     , (SELECT COUNT(*) FROM TB_ATTACH WHERE SR_ID = TS.SR_ID) as attachNum

FROM   TB_SR TS
       LEFT OUTER JOIN TB_USER TU
       ON TS.REQ_EMP_ID = TU.USER_ID
       LEFT OUTER JOIN TB_USER TU2
       ON TS.CHRG_EMP_ID = TU2.USER_ID
       LEFT OUTER JOIN TB_DEPT TD
       ON TS.REQ_EMP_DEPT_ID = TD.DEPT_ID
       LEFT OUTER JOIN TB_SYSTEM TSYS
       ON TS.SYS_ID = TSYS.SYS_ID
       LEFT OUTER JOIN TB_SR_TYPE TST
       ON TS.SR_TYPE_ID = TST.SR_TYPE_ID
WHERE  IF_TYPE = 'RTC'
AND    IF_YN = 'N'
    
</select>

<select id="selectTicketSRList"  resultType="PushVO">	

SELECT TS.SR_ID AS srId
     , TS.SR_TYPE_ID AS reqType
     , TU.USER_NM  AS reqEmpNm 
     , TS.REQ_EMP_DEPT_ID AS reqDeptId
     , TD.DEPT_NM AS reqEmpDeptNm
     , TS.REQ_EMP_EMAIL AS reqEmail
     , TS.REQ_EMP_TEL AS reqTel
     , TS.TITLE AS reqTitle
     , TCD.CD_NM || '/' || TSYS.SYS_NM  || '/' || TM.MOD_NM || CHR(13)|| TS."DESC" AS reqDesc
     , VARCHAR_FORMAT(TS.TGT_DTTM, 'YYYYMMDD') AS expDate
     , VARCHAR_FORMAT(TS.CRT_DTTM, 'YYYYMMDD') AS recDate
FROM   TB_SR TS
       LEFT OUTER JOIN TB_USER TU
       ON TS.REQ_EMP_ID = TU.USER_ID
       LEFT OUTER JOIN TB_DEPT TD
       ON TS.REQ_EMP_DEPT_ID = TD.DEPT_ID
       LEFT OUTER JOIN TB_SYSTEM TSYS
       ON TS.SYS_ID = TSYS.SYS_ID
       LEFT OUTER JOIN TB_SR_TYPE TST
       ON TS.SR_TYPE_ID = TST.SR_TYPE_ID
       LEFT OUTER JOIN TB_MODULE TM
       ON TS.MOD_ID = TM.MOD_ID
       LEFT OUTER JOIN TB_COMM_DETAIL TCD
       ON TS.SYS_CATE_ID = TCD.CD_ID AND TCD.CD_GRP_ID = 'HWCAT'
WHERE  IF_TYPE = 'TKT'
AND    IF_YN = 'N'  

    
</select>


<update id="updateInterfaceYn" parameterType="String">

UPDATE TB_SR
SET    IF_YN = 'Y'

</update>


<select id="selectRTCResult" resultType="RTCResultVO">

SELECT SR_ID
     , SEQ
     , RTC_ID
     , STATUS_CD
     , WORK_NM
     , WORK_DATE
     , RESULT_DESC
     , RTC_RCV
     , RTC_RCV_DATE
     , SR_UPD_DATE
     , REFLECT_YN 
FROM   TB_RTCRESULT
WHERE  REFLECT_YN != 'N'

</select>


<select id="selectFileListBySrId" parameterType="String" resultType="FilePushVO">

SELECT SR_ID as srId
     , ORG_FILE_NM as fileName
     , FILE_DIR as fileUrl
FROM   TB_ATTACH
WHERE  SR_ID = #{srId}

</select>


<select id="selectTicketResult" resultType="TicketResultVO">

SELECT SR_ID
     , SEQ
     , TICKET_ID
     , STATUS_CD
     , WORK_NM
     , WORK_DATE
     , RESULT_DESC
     , TICKET_RCV
     , TICKET_RCV_DATE
     , SR_UPD_DATE
     , REFLECT_YN 
FROM   TB_TICKETRESULT
WHERE  REFLECT_YN != 'N'

</select>

<update id="updateSRWithRTCInfo" parameterType="RTCResultVO">

UPDATE TB_SR
SET    LAST_MOD_DTTM = TIMESTAMP_FORMAT(#{srUpdDate}, 'YYYYMMDDHHMISS')
<if test="status != null and status != ''">
     , STATUS = #{status} 
</if>
<if test="resultDesc != null and resultDesc != ''">
     , resultDesc = #{resultDesc} 
</if>
<if test="workNm != null and workNm != ''">
     , workNm = #{workNm} 
</if>
<if test="workDate != null and workDate != ''">
     , CLOSE_DTTM = TIMESTAMP_FORMAT(#{workDate}, 'YYYYMMDD')
</if>

WHERE  SR_ID = #{srId}

</update>

<update id="updateSRWithTicketInfo" parameterType="TicketResultVO">

UPDATE TB_SR
SET    LAST_MOD_DTTM = TIMESTAMP_FORMAT(#{srUpdDate}, 'YYYYMMDDHHMISS')
<if test="status != null and status != ''">
     , STATUS = #{status} 
</if>
<if test="resultDesc != null and resultDesc != ''">
     , resultDesc = #{resultDesc} 
</if>
<if test="workNm != null and workNm != ''">
     , workNm = #{workNm} 
</if>
<if test="workDate != null and workDate != ''">
     , CLOSE_DTTM = TIMESTAMP_FORMAT(#{workDate}, 'YYYYMMDD')
</if>

WHERE  SR_ID = #{srId}

</update>
